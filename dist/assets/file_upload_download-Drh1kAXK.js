import{U as q,d as Te,r as i,i as R,D as Le,b as d,G as ze,c as y,o as u,f as s,e as a,w as o,h as f,F as C,B as V,j as w,k as b,H as Be,I as Pe,y as T,J as Re,K as Me,L as Qe,M as I,g as oe,l as se,z as ne,N as ie,$ as ue,E as c,O as je,P as re,_ as qe}from"./index-DVCaOt51.js";const Ee=async(H,U)=>{const k=await fetch(`${q}${H}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U)});if(!k.ok){const B=await k.json();throw new Error(B.detail||`HTTP error! status: ${k.status}`)}const z=k.headers.get("Content-Disposition")?.match(/filename="?(.+?)"?$/)?.[1]||"download.zip",E=await k.blob(),v=window.URL.createObjectURL(E),m=document.createElement("a");m.href=v,m.download=z,document.body.appendChild(m),m.click(),setTimeout(()=>{document.body.removeChild(m),window.URL.revokeObjectURL(v)},100)},Fe={class:"file-manager-container"},Oe={class:"connection-bar"},Se={class:"connection-controls"},Ge={class:"main-content"},Ne={class:"browser-header"},Ie={class:"path-navigator"},He={class:"file-item"},Ae={class:"file-name"},Je={class:"upload-row"},Ke={class:"upload-row"},Ye={class:"upload-queue"},Xe={class:"file-info"},We={class:"file-progress"},Ze={class:"file-actions"},el={class:"upload-queue"},ll={class:"file-info"},tl={class:"file-progress"},al={class:"file-actions"},ol=Te({__name:"file_upload_download",setup(H){const U=i(""),k=i("/data/testing_data"),L=i([]),z=i(!1),E=i(!0),v=i(!1),m=i("/"),B=i(""),M=i("下载目录"),A=i([]),F=i(!1),de=R(()=>`${q}/api/files/upload?file=${m.value}`),J=R(()=>({Authorization:E.value?"Bearer your-secret-token":""})),K=R(()=>({path:m.value})),_=i([]),ce=R(()=>`${q}/api/files/upload/testing_data?file=${m.value}`),pe=i([]),_e=t=>{if(t===0)return"0 Bytes";const e=1024,n=["Bytes","KB","MB","GB","TB"],r=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,r)).toFixed(2))+" "+n[r]},Y=R(()=>m.value.split("/").filter(t=>t!==""));async function X(){z.value=!0,L.value=[];try{const e=(await ue("/api/flex/discover")).flex_group;for(const r in e)L.value.push({value:r,label:`${e[r].name} (${r})`});const n=Object.keys(e).length;n>0&&(U.value=L.value[0].value,v.value=!0),c.info(`找到${n}个设备!`)}catch(t){console.error("Error:",t),c.error("设备刷新失败: "+t.message)}finally{z.value=!1}}const ve=t=>{t?v.value=!0:v.value=!1},me=async()=>{c.info("开始下载"),M.value="正在下载",v.value=!1;const t={host:U.value,user_name:"root",download_path:k.value,saved_name:"testing_data"},e=await fetch(`${q}/api/flex/download/testing_data`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const P=await e.json();throw c.error(`下载失败, ${P.detail}`),M.value="下载目录",v.value=!0,new Error(P.detail||`HTTP error! status: ${e.status}`)}const r=e.headers.get("Content-Disposition")?.match(/filename="?(.+?)"?$/)?.[1]||"download.zip",$=await e.blob(),p=window.URL.createObjectURL($),x=document.createElement("a");x.href=p,x.download=r,document.body.appendChild(x),x.click(),c.success("下载成功"),M.value="下载目录",v.value=!0,setTimeout(()=>{document.body.removeChild(x),window.URL.revokeObjectURL(p)},100)},Q=async()=>{try{F.value=!0;const t=await ue("/api/files/fetch/filelist");A.value=t.files.map(e=>({...e,modified:e.modified}))}catch(t){c.error("获取文件列表失败: "+t.message)}finally{F.value=!1}},fe=t=>{const e=Y.value.slice(0,t+1);m.value="/"+e.join("/"),Q()},be=async t=>{const e={url:t.url,file_name:t.name};await Ee("/api/files/download",e)},ge=async t=>{try{await je.confirm(`确定要删除文件 "${t.name}" 吗？此操作不可恢复！`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"});const e={url:t.url,file_name:t.name},n=await re("api/files/delete",e);n.status_code===200?(c.success("删除成功"),await Q()):c.error(`删除失败: ${n.detail}`)}catch(e){e!=="cancel"&&(console.error("删除出错:",e),c.error(`删除操作出错: ${e.message||e}`))}},he=i([{label:"PVT-Robot",value:"product_a"},{label:"PVT-Robot-Ultima",value:"product_b"},{label:"PVT-Pipette",value:"product_c"}]),O=i(""),S=i(""),ye=i([{label:"belt-calibration-ot3",value:"belt-calibration-ot3"},{label:"robot-assembly-qc-ot3",value:"robot-assembly-qc-ot3"},{label:"stress-test-qc-ot3",value:"stress-test-qc-ot3"}]),g=new Date().getFullYear();i(Array.from({length:5},(t,e)=>g-e)),i(g);const we=i([{label:`${g}-Q1 (1-3月)`,value:`${g}-Q1`},{label:`${g}-Q2 (4-6月)`,value:`${g}-Q2`},{label:`${g}-Q3 (7-9月)`,value:`${g}-Q3`},{label:`${g}-Q4 (10-12月)`,value:`${g}-Q4`}]),G=i("2025-Q1"),W=t=>t.size>100*1024*1024?(c.error("文件大小不能超过100MB"),!1):(_.value.push({name:t.name,size:t.size,progress:0,status:"uploading",file:t}),!0),ke=(t,e)=>{const n=_.value.findIndex(r=>r.name===e.name);n!==-1&&(_.value[n].progress=100,_.value[n].status="success"),Q(),c.success(`${e.name} 上传成功`)},$e=async(t,e)=>{const n=_.value.findIndex(p=>p.name===e.name);n!==-1&&(_.value[n].progress=100,_.value[n].status="success");const r=t.status,$=t.files_list;if(r!="success"){c.error("上传失败");return}else{const p={product_name:O.value,quarter_name:G.value,sn:B.value,test_name:S.value,files_list:$};await re("/api/google/drive/upload/report",p),c.success(`${e.name} 上传成功`)}},Z=(t,e)=>{const n=_.value.findIndex(r=>r.name===e.name);n!==-1&&(_.value[n].status="exception"),c.error(`${e.name} 上传失败: ${t.message}`)},ee=t=>{_.value[t].status="exception",c.warning(`已取消上传: ${_.value[t].name}`)};return Le(()=>{X(),Q()}),(t,e)=>{const n=d("el-text"),r=d("el-option"),$=d("el-select"),p=d("el-button"),x=d("el-divider"),P=d("el-input"),N=d("el-card"),xe=d("el-breadcrumb-item"),Ce=d("el-breadcrumb"),D=d("el-icon"),j=d("el-table-column"),Ve=d("el-table"),Ue=d("el-tooltip"),le=d("el-upload"),te=d("el-progress"),De=ze("loading");return u(),y("div",Fe,[s("div",Oe,[a(N,{shadow:"hover"},{default:o(()=>[s("div",Se,[a(n,{class:"control-label"},{default:o(()=>e[8]||(e[8]=[f("FLEX设备")])),_:1,__:[8]}),a($,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=l=>U.value=l),placeholder:"选择设备",style:{width:"300px"},filterable:"","allow-create":"",clearable:"",onChange:ve},{default:o(()=>[(u(!0),y(C,null,V(L.value,l=>(u(),w(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(p,{loading:z.value,type:"primary",size:"small",onClick:X,icon:b(Be)},{default:o(()=>e[9]||(e[9]=[f(" 刷新设备 ")])),_:1,__:[9]},8,["loading","icon"]),a(x,{direction:"vertical"}),a(n,{class:"control-label"},{default:o(()=>e[10]||(e[10]=[f("下载路径")])),_:1,__:[10]}),a(P,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=l=>k.value=l),style:{width:"300px"},placeholder:"/data/testing_data",clearable:""},null,8,["modelValue"]),a(p,{type:"primary",disabled:!v.value,onClick:me,icon:b(Pe),style:{"margin-left":"20px"}},{default:o(()=>[f(T(M.value),1)]),_:1},8,["disabled","icon"]),a(p,{type:"danger",disabled:!v.value,onClick:e[2]||(e[2]=()=>{}),icon:b(Re),style:{"margin-left":"10px"}},{default:o(()=>e[11]||(e[11]=[f(" 删除目录 ")])),_:1,__:[11]},8,["disabled","icon"])])]),_:1})]),s("div",Ge,[a(N,{class:"file-browser",shadow:"hover"},{header:o(()=>[s("div",Ne,[e[12]||(e[12]=s("span",null,"文件服务器",-1)),s("div",Ie,[a(Ce,{separator:"/"},{default:o(()=>[(u(!0),y(C,null,V(Y.value,(l,h)=>(u(),w(xe,{key:h,onClick:ae=>fe(h)},{default:o(()=>[f(T(l||"根目录"),1)]),_:2},1032,["onClick"]))),128))]),_:1})])])]),default:o(()=>[Me((u(),w(Ve,{data:A.value,style:{width:"100%"},height:"100%",onRowClick:e[3]||(e[3]=()=>{})},{default:o(()=>[a(j,{prop:"name",label:"名称",width:"400"},{default:o(({row:l})=>[s("div",He,[l.type==="directory"?(u(),w(D,{key:0},{default:o(()=>[a(b(Qe))]),_:1})):(u(),w(D,{key:1},{default:o(()=>[a(b(I))]),_:1})),s("span",Ae,T(l.name),1)])]),_:1}),a(j,{prop:"size",label:"大小",width:"120"},{default:o(({row:l})=>[f(T(l.type==="directory"?"-":_e(l.size)),1)]),_:1}),a(j,{prop:"modified",label:"修改时间",width:"200"}),a(j,{label:"操作",width:"220",fixed:"right"},{default:o(({row:l})=>[a(p,{size:"small",type:"primary",onClick:oe(h=>be(l),["stop"]),title:"下载"},{default:o(()=>e[13]||(e[13]=[f(" 下载 ")])),_:2,__:[13]},1032,["onClick"]),a(p,{size:"small",type:"danger",onClick:oe(h=>ge(l),["stop"]),title:"删除",style:{"margin-left":"8px"}},{default:o(()=>e[14]||(e[14]=[f(" 删除 ")])),_:2,__:[14]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[De,F.value]])]),_:1}),a(N,{class:"upload-panel",shadow:"hover"},{default:o(()=>[e[20]||(e[20]=s("span",{style:{"margin-bottom":"12px"}},"上传到Google Drive",-1)),s("div",Je,[a($,{style:{"margin-right":"10px",width:"220px"},modelValue:O.value,"onUpdate:modelValue":e[4]||(e[4]=l=>O.value=l),placeholder:"请选择产品",clearable:""},{default:o(()=>[(u(!0),y(C,null,V(he.value,l=>(u(),w(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a($,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=l=>S.value=l),placeholder:"请选择测试名",clearable:""},{default:o(()=>[(u(!0),y(C,null,V(ye.value,l=>(u(),w(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s("div",Ke,[e[15]||(e[15]=s("span",{class:"upload-label"},"季度：",-1)),a($,{modelValue:G.value,"onUpdate:modelValue":e[6]||(e[6]=l=>G.value=l),placeholder:"选择季度",style:{width:"150px","margin-left":"2px","margin-right":"10px"}},{default:o(()=>[(u(!0),y(C,null,V(we.value,l=>(u(),w(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(Ue,{content:"请输入条码，如果为空，默认上传文件内所有的测试结果",placement:"top"},{default:o(()=>[a(P,{modelValue:B.value,"onUpdate:modelValue":e[7]||(e[7]=l=>B.value=l),type:"",placeholder:"输入条码",style:{width:"200px","margin-left":"auto"}},null,8,["modelValue"])]),_:1})]),a(le,{class:"upload-area",drag:"",multiple:"",action:ce.value,headers:J.value,data:K.value,"before-upload":W,"on-success":$e,"on-error":Z,"show-file-list":!1},{tip:o(()=>e[16]||(e[16]=[s("div",{class:"el-upload__tip"}," 请选择下载的 testing_data.zip 上传 ",-1)])),default:o(()=>[a(D,{class:"el-icon--upload2"},{default:o(()=>[a(b(se))]),_:1}),e[17]||(e[17]=s("div",{class:"el-upload__text"},[f(" 拖拽文件到此处或"),s("em",null,"点击上传到Google Drive")],-1))]),_:1,__:[17]},8,["action","headers","data"]),s("div",Ye,[(u(!0),y(C,null,V(pe.value,(l,h)=>(u(),y("div",{key:l.name+h,class:"queue-item"},[s("div",Xe,[a(D,null,{default:o(()=>[a(b(I))]),_:1}),s("span",null,T(l.name),1)]),s("div",We,[a(te,{percentage:l.progress,status:l.status,"stroke-width":12},null,8,["percentage","status"])]),s("div",Ze,[l.status==="uploading"?(u(),w(p,{key:0,size:"small",type:"danger",onClick:ae=>ee(h),icon:b(ie),circle:""},null,8,["onClick","icon"])):ne("",!0)])]))),128))]),e[21]||(e[21]=s("span",{style:{"margin-bottom":"6px"}},"上传到文件服务器",-1)),a(le,{class:"upload-area",drag:"",multiple:"",action:de.value,headers:J.value,data:K.value,"before-upload":W,"on-success":ke,"on-error":Z,"show-file-list":!1},{tip:o(()=>e[18]||(e[18]=[s("div",{class:"el-upload__tip"}," 支持上传多个文件，单文件最大100MB ",-1)])),default:o(()=>[a(D,{class:"el-icon--upload"},{default:o(()=>[a(b(se))]),_:1}),e[19]||(e[19]=s("div",{class:"el-upload__text"},[f(" 拖拽文件到此处或"),s("em",null,"点击上传")],-1))]),_:1,__:[19]},8,["action","headers","data"]),s("div",el,[(u(!0),y(C,null,V(_.value,(l,h)=>(u(),y("div",{key:l.name+h,class:"queue-item"},[s("div",ll,[a(D,null,{default:o(()=>[a(b(I))]),_:1}),s("span",null,T(l.name),1)]),s("div",tl,[a(te,{percentage:l.progress,status:l.status,"stroke-width":12},null,8,["percentage","status"])]),s("div",al,[l.status==="uploading"?(u(),w(p,{key:0,size:"small",type:"danger",onClick:ae=>ee(h),icon:b(ie),circle:""},null,8,["onClick","icon"])):ne("",!0)])]))),128))])]),_:1,__:[20,21]})])])}}}),nl=qe(ol,[["__scopeId","data-v-20bf0d35"]]);export{nl as default};
