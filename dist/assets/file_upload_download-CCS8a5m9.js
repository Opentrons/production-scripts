import{U as P,d as Ce,r as d,i as E,D as $e,b as u,G as De,c as g,o as n,f as s,e as t,w as o,h as _,F as x,B as C,j as h,k as v,H as Ue,I as Le,y as V,J as Ve,K as Be,L as ze,M as O,g as se,l as ne,z as ie,N as de,$ as re,E as p,O as Te,P as Me,_ as je}from"./index-DgyFvu3H.js";const Ee=async(N,$)=>{const w=await fetch(`${P}${N}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($)});if(!w.ok){const D=await w.json();throw new Error(D.detail||`HTTP error! status: ${w.status}`)}const z=w.headers.get("Content-Disposition")?.match(/filename="?(.+?)"?$/)?.[1]||"download.zip",F=await w.blob(),c=window.URL.createObjectURL(F),m=document.createElement("a");m.href=c,m.download=z,document.body.appendChild(m),m.click(),setTimeout(()=>{document.body.removeChild(m),window.URL.revokeObjectURL(c)},100)},Fe={class:"file-manager-container"},Qe={class:"connection-bar"},Re={class:"connection-controls"},Oe={class:"main-content"},Pe={class:"browser-header"},Ne={class:"path-navigator"},Se={class:"file-item"},qe={class:"file-name"},Ge={class:"upload-row"},Ae={class:"upload-row"},He={class:"upload-queue"},Ie={class:"file-info"},Je={class:"file-progress"},Ye={class:"file-actions"},Ke={class:"upload-queue"},Xe={class:"file-info"},We={class:"file-progress"},Ze={class:"file-actions"},el=Ce({__name:"file_upload_download",setup(N){const $=d(""),w=d("/data/testing_data"),B=d([]),z=d(!1),F=d(!0),c=d(!1),m=d("/"),D=d("下载目录"),S=d([]),Q=d(!1),q=E(()=>`${P}/api/files/upload?file=${m.value}`),G=E(()=>({Authorization:F.value?"Bearer your-secret-token":""})),A=E(()=>({path:m.value})),y=d([]),ue=d([]),ce=a=>{if(a===0)return"0 Bytes";const e=1024,i=["Bytes","KB","MB","GB","TB"],r=Math.floor(Math.log(a)/Math.log(e));return parseFloat((a/Math.pow(e,r)).toFixed(2))+" "+i[r]},H=E(()=>m.value.split("/").filter(a=>a!==""));async function I(){z.value=!0,B.value=[];try{const e=(await re("/api/flex/discover")).flex_group;for(const r in e)B.value.push({value:r,label:`${e[r].name} (${r})`});const i=Object.keys(e).length;i>0&&($.value=B.value[0].value,c.value=!0),p.info(`找到${i}个设备!`)}catch(a){console.error("Error:",a),p.error("设备刷新失败: "+a.message)}finally{z.value=!1}}const pe=a=>{a?c.value=!0:c.value=!1},_e=async()=>{p.info("开始下载"),D.value="正在下载",c.value=!1;const a={host:$.value,user_name:"root",download_path:w.value,saved_name:"testing_data"},e=await fetch(`${P}/api/flex/download/testing_data`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok){const M=await e.json();throw p.error(`下载失败, ${M.detail}`),D.value="下载目录",c.value=!0,new Error(M.detail||`HTTP error! status: ${e.status}`)}const r=e.headers.get("Content-Disposition")?.match(/filename="?(.+?)"?$/)?.[1]||"download.zip",U=await e.blob(),f=window.URL.createObjectURL(U),k=document.createElement("a");k.href=f,k.download=r,document.body.appendChild(k),k.click(),p.success("下载成功"),D.value="下载目录",c.value=!0,setTimeout(()=>{document.body.removeChild(k),window.URL.revokeObjectURL(f)},100)},T=async()=>{try{Q.value=!0;const a=await re("/api/files/fetch/filelist");S.value=a.files.map(e=>({...e,modified:e.modified}))}catch(a){p.error("获取文件列表失败: "+a.message)}finally{Q.value=!1}},ve=a=>{const e=H.value.slice(0,a+1);m.value="/"+e.join("/"),T()},me=async a=>{const e={url:a.url,file_name:a.name};await Ee("/api/files/download",e)},fe=async a=>{try{await Te.confirm(`确定要删除文件 "${a.name}" 吗？此操作不可恢复！`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"});const e={url:a.url,file_name:a.name},i=await Me("api/files/delete",e);i.status_code===200?(p.success("删除成功"),await T()):p.error(`删除失败: ${i.detail}`)}catch(e){e!=="cancel"&&(console.error("删除出错:",e),p.error(`删除操作出错: ${e.message||e}`))}},be=d([{label:"产品A",value:"product_a"},{label:"产品B",value:"product_b"},{label:"产品C",value:"product_c"}]),J=d(""),Y=new Date().getFullYear(),ge=d(Array.from({length:5},(a,e)=>Y-e)),K=d(Y),he=d([{label:"Q1 (1-3月)",value:"Q1"},{label:"Q2 (4-6月)",value:"Q2"},{label:"Q3 (7-9月)",value:"Q3"},{label:"Q4 (10-12月)",value:"Q4"}]),X=d(""),W=a=>a.size>100*1024*1024?(p.error("文件大小不能超过100MB"),!1):(y.value.push({name:a.name,size:a.size,progress:0,status:"uploading",file:a}),!0),Z=(a,e)=>{const i=y.value.findIndex(r=>r.name===e.name);i!==-1&&(y.value[i].progress=100,y.value[i].status="success"),T(),p.success(`${e.name} 上传成功`)},ee=(a,e)=>{const i=y.value.findIndex(r=>r.name===e.name);i!==-1&&(y.value[i].status="exception"),p.error(`${e.name} 上传失败: ${a.message}`)},le=a=>{y.value[a].status="exception",p.warning(`已取消上传: ${y.value[a].name}`)};return $e(()=>{I(),T()}),(a,e)=>{const i=u("el-text"),r=u("el-option"),U=u("el-select"),f=u("el-button"),k=u("el-divider"),M=u("el-input"),R=u("el-card"),we=u("el-breadcrumb-item"),ye=u("el-breadcrumb"),L=u("el-icon"),j=u("el-table-column"),ke=u("el-table"),ae=u("el-upload"),te=u("el-progress"),xe=De("loading");return n(),g("div",Fe,[s("div",Qe,[t(R,{shadow:"hover"},{default:o(()=>[s("div",Re,[t(i,{class:"control-label"},{default:o(()=>e[7]||(e[7]=[_("FLEX设备")])),_:1,__:[7]}),t(U,{modelValue:$.value,"onUpdate:modelValue":e[0]||(e[0]=l=>$.value=l),placeholder:"选择设备",style:{width:"300px"},filterable:"","allow-create":"",clearable:"",onChange:pe},{default:o(()=>[(n(!0),g(x,null,C(B.value,l=>(n(),h(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(f,{loading:z.value,type:"primary",size:"small",onClick:I,icon:v(Ue)},{default:o(()=>e[8]||(e[8]=[_(" 刷新设备 ")])),_:1,__:[8]},8,["loading","icon"]),t(k,{direction:"vertical"}),t(i,{class:"control-label"},{default:o(()=>e[9]||(e[9]=[_("下载路径")])),_:1,__:[9]}),t(M,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=l=>w.value=l),style:{width:"300px"},placeholder:"/data/testing_data",clearable:""},null,8,["modelValue"]),t(f,{type:"primary",disabled:!c.value,onClick:_e,icon:v(Le),style:{"margin-left":"20px"}},{default:o(()=>[_(V(D.value),1)]),_:1},8,["disabled","icon"]),t(f,{type:"danger",disabled:!c.value,onClick:e[2]||(e[2]=()=>{}),icon:v(Ve),style:{"margin-left":"10px"}},{default:o(()=>e[10]||(e[10]=[_(" 删除目录 ")])),_:1,__:[10]},8,["disabled","icon"])])]),_:1})]),s("div",Oe,[t(R,{class:"file-browser",shadow:"hover"},{header:o(()=>[s("div",Pe,[e[11]||(e[11]=s("span",null,"文件服务器",-1)),s("div",Ne,[t(ye,{separator:"/"},{default:o(()=>[(n(!0),g(x,null,C(H.value,(l,b)=>(n(),h(we,{key:b,onClick:oe=>ve(b)},{default:o(()=>[_(V(l||"根目录"),1)]),_:2},1032,["onClick"]))),128))]),_:1})])])]),default:o(()=>[Be((n(),h(ke,{data:S.value,style:{width:"100%"},height:"100%",onRowClick:e[3]||(e[3]=()=>{})},{default:o(()=>[t(j,{prop:"name",label:"名称",width:"400"},{default:o(({row:l})=>[s("div",Se,[l.type==="directory"?(n(),h(L,{key:0},{default:o(()=>[t(v(ze))]),_:1})):(n(),h(L,{key:1},{default:o(()=>[t(v(O))]),_:1})),s("span",qe,V(l.name),1)])]),_:1}),t(j,{prop:"size",label:"大小",width:"120"},{default:o(({row:l})=>[_(V(l.type==="directory"?"-":ce(l.size)),1)]),_:1}),t(j,{prop:"modified",label:"修改时间",width:"200"}),t(j,{label:"操作",width:"220",fixed:"right"},{default:o(({row:l})=>[t(f,{size:"small",type:"primary",onClick:se(b=>me(l),["stop"]),title:"下载"},{default:o(()=>e[12]||(e[12]=[_(" 下载 ")])),_:2,__:[12]},1032,["onClick"]),t(f,{size:"small",type:"danger",onClick:se(b=>fe(l),["stop"]),title:"删除",style:{"margin-left":"8px"}},{default:o(()=>e[13]||(e[13]=[_(" 删除 ")])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[xe,Q.value]])]),_:1}),t(R,{class:"upload-panel",shadow:"hover"},{default:o(()=>[e[19]||(e[19]=s("span",{style:{"margin-bottom":"12px"}},"上传到Google Drive",-1)),s("div",Ge,[t(U,{modelValue:J.value,"onUpdate:modelValue":e[4]||(e[4]=l=>J.value=l),placeholder:"请选择产品",clearable:""},{default:o(()=>[(n(!0),g(x,null,C(be.value,l=>(n(),h(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s("div",Ae,[e[14]||(e[14]=s("span",{class:"upload-label"},"目标目录：",-1)),t(U,{modelValue:K.value,"onUpdate:modelValue":e[5]||(e[5]=l=>K.value=l),placeholder:"选择年份",style:{width:"120px"}},{default:o(()=>[(n(!0),g(x,null,C(ge.value,l=>(n(),h(r,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(U,{modelValue:X.value,"onUpdate:modelValue":e[6]||(e[6]=l=>X.value=l),placeholder:"选择季度",style:{width:"120px","margin-left":"10px"}},{default:o(()=>[(n(!0),g(x,null,C(he.value,l=>(n(),h(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t(ae,{class:"upload-area",drag:"",multiple:"",action:q.value,headers:G.value,data:A.value,"before-upload":W,"on-success":Z,"on-error":ee,"show-file-list":!1,disabled:!c.value},{tip:o(()=>e[15]||(e[15]=[s("div",{class:"el-upload__tip"}," 请选择下载的 testing_data.zip 上传 ",-1)])),default:o(()=>[t(L,{class:"el-icon--upload2"},{default:o(()=>[t(v(ne))]),_:1}),e[16]||(e[16]=s("div",{class:"el-upload__text"},[_(" 拖拽文件到此处或"),s("em",null,"点击上传到Google Drive")],-1))]),_:1,__:[16]},8,["action","headers","data","disabled"]),s("div",He,[(n(!0),g(x,null,C(ue.value,(l,b)=>(n(),g("div",{key:l.name+b,class:"queue-item"},[s("div",Ie,[t(L,null,{default:o(()=>[t(v(O))]),_:1}),s("span",null,V(l.name),1)]),s("div",Je,[t(te,{percentage:l.progress,status:l.status,"stroke-width":12},null,8,["percentage","status"])]),s("div",Ye,[l.status==="uploading"?(n(),h(f,{key:0,size:"small",type:"danger",onClick:oe=>le(b),icon:v(de),circle:""},null,8,["onClick","icon"])):ie("",!0)])]))),128))]),e[20]||(e[20]=s("span",{style:{"margin-bottom":"6px"}},"上传到文件服务器",-1)),t(ae,{class:"upload-area",drag:"",multiple:"",action:q.value,headers:G.value,data:A.value,"before-upload":W,"on-success":Z,"on-error":ee,"show-file-list":!1,disabled:!c.value},{tip:o(()=>e[17]||(e[17]=[s("div",{class:"el-upload__tip"}," 支持上传多个文件，单文件最大100MB ",-1)])),default:o(()=>[t(L,{class:"el-icon--upload"},{default:o(()=>[t(v(ne))]),_:1}),e[18]||(e[18]=s("div",{class:"el-upload__text"},[_(" 拖拽文件到此处或"),s("em",null,"点击上传")],-1))]),_:1,__:[18]},8,["action","headers","data","disabled"]),s("div",Ke,[(n(!0),g(x,null,C(y.value,(l,b)=>(n(),g("div",{key:l.name+b,class:"queue-item"},[s("div",Xe,[t(L,null,{default:o(()=>[t(v(O))]),_:1}),s("span",null,V(l.name),1)]),s("div",We,[t(te,{percentage:l.progress,status:l.status,"stroke-width":12},null,8,["percentage","status"])]),s("div",Ze,[l.status==="uploading"?(n(),h(f,{key:0,size:"small",type:"danger",onClick:oe=>le(b),icon:v(de),circle:""},null,8,["onClick","icon"])):ie("",!0)])]))),128))])]),_:1,__:[19,20]})])])}}}),al=je(el,[["__scopeId","data-v-845333dd"]]);export{al as default};
